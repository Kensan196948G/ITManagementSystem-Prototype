# Microsoft Entra ID アプリケーション設定ガイド

## Microsoft Entra ID アプリケーションのクライアントIDとテナントIDの取得方法

### 前提条件
- Microsoft 365管理者アカウント（グローバル管理者権限推奨）
- Webブラウザ

### アプリケーション登録手順

1. **Azure ポータルにサインイン**
   - [Azure Portal](https://portal.azure.com/) にアクセスします
   - Microsoft 365の管理者アカウントでサインインします

2. **アプリケーション登録ページに移動**
   - 左側のナビゲーションメニューから「Microsoft Entra ID」（旧Azure Active Directory）を選択します
   - 「アプリの登録」を選択します

3. **新しいアプリケーションを登録**
   - 「新規登録」ボタンをクリックします
   - 以下の情報を入力します：
     - **名前**: `IT管理システムAPI` （任意の識別しやすい名前）
     - **サポートされているアカウントの種類**: 「この組織のディレクトリ内のアカウントのみ（シングルテナント）」を選択
     - **リダイレクトURI**: 「パブリッククライアント（モバイルとデスクトップ）」を選び、URIは空白でも構いません

4. **「登録」ボタンをクリック**
   - アプリケーションが作成されます

5. **アプリケーション情報の確認**
   - 作成されたアプリケーションの「概要」ページが表示されます
   - 以下の情報をメモします：
     - **アプリケーション（クライアント）ID**: これが`APIPermission.ps1`スクリプトで必要な`$clientId`の値です
     - **ディレクトリ（テナント）ID**: これが`APIPermission.ps1`スクリプトで必要な`$tenantId`の値です

6. **API権限の設定**
   - 左側のナビゲーションから「API権限」を選択します
   - 「権限の追加」ボタンをクリックします
   - 「Microsoft Graph」を選択します
   - 「アプリケーション権限」を選択します
   - 以下の権限を追加します：
     - `Directory.Read.All`（ディレクトリデータの読み取り）
     - `Directory.ReadWrite.All`（ディレクトリデータの読み取りと書き込み）
     - `User.Read.All`（すべてのユーザーの基本プロファイルの読み取り）
     - `User.ReadWrite.All`（すべてのユーザープロファイルの読み取りと更新）
   - 「権限の追加」をクリックして確定します

7. **管理者の同意を付与**
   - 追加した権限の一覧が表示されます
   - 「～に管理者の同意を与えます」ボタンをクリックします
   - 確認ダイアログで「はい」をクリックします

8. **認証の設定**
   - 左側のナビゲーションから「認証」を選択します
   - 「プラットフォームの追加」→「モバイルとデスクトップアプリケーション」を選択します
   - リダイレクトURIで「https://login.microsoftonline.com/common/oauth2/nativeclient」にチェックを入れます
   - 「構成」をクリックして保存します

9. **デバイスコードフローの有効化**
   - 左側のナビゲーションから「認証」を選択します（既に表示されている場合はこのステップは不要）
   - 「詳細設定」セクションまでスクロールします
   - 「デバイスコードフローを許可」を「はい」に設定します
   - 「保存」をクリックします

### PowerShellスクリプトでの使用方法

取得したクライアントIDとテナントIDを以下のいずれかの方法でPowerShellスクリプトに提供します：

1. **環境変数として設定**
   ```powershell
   $env:M365_CLIENT_ID = "取得したクライアントID"
   $env:M365_TENANT_ID = "取得したテナントID"
   .\APIPermission.ps1
   ```

2. **スクリプト実行時の入力プロンプト**
   ```powershell
   .\APIPermission.ps1
   # プロンプトが表示されたら、クライアントIDとテナントIDを入力
   ```

3. **スクリプトを編集して直接値を埋め込む**
   ```powershell
   # APIPermission.ps1を編集
   $clientId = "取得したクライアントID"
   $tenantId = "取得したテナントID"
   ```

### トラブルシューティング

1. **アクセス権の問題が発生する場合**
   - すべての必要な権限が追加され、管理者の同意が与えられていることを確認します
   - グローバル管理者または特権管理者のアカウントでアクセスしていることを確認します

2. **認証エラーが発生する場合**
   - クライアントIDとテナントIDが正しく設定されていることを確認します
   - デバイスコードフローが有効になっていることを確認します

3. **APIエラーが発生する場合**
   - APIのレスポンスエラーをログで確認し、該当する権限が付与されているか確認します
