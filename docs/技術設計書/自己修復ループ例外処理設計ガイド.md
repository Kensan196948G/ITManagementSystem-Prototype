# 自己修復ループ例外処理設計ガイド

## 目的

このドキュメントは、自己修復ループ機能における例外処理の設計指針について説明します。適切に設計された例外処理は、エラーの原因特定、自動修復の精度向上、およびシステムの保守性向上に不可欠です。

## 例外クラス設計

自己修復ループに関連するエラーを示す場合は、`backend.self_healing.exceptions` モジュールで定義されているカスタム例外クラスを使用します。これにより、エラーの種類に応じたハンドリングやログ記録が可能になります。

### 例外階層

基本的な例外クラスとして `AutoRepairError` を定義し、具体的なエラーを示す例外クラスはそれを継承します。

- `AutoRepairError`: 自己修復関連の例外の基底クラス。
- `AutoRepairFailedError`: 自動修復処理が失敗した場合に発生する例外。エラーに関する詳細情報を含みます。
    - `SyntaxErrorDuringRepair`: 修復中に構文エラーが発生した場合の例外。
    - `DependencyErrorDuringRepair`: 修復中に依存関係エラーが発生した場合の例外。
    - （将来的な拡張）`GraphAPIErrorDuringRepair`: Microsoft Graph API連携中にエラーが発生した場合の例外。
    - （将来的な拡張）`PowerShellScriptErrorDuringRepair`: PowerShellスクリプト実行中にエラーが発生した場合の例外。

### 例外に含まれる情報

`AutoRepairFailedError` およびその派生クラスには、以下の情報を含めることで、エラーの原因特定とデバッグを容易にします。

- `message`: エラーの概要を示すメッセージ。
- `file`: エラーが発生したファイル名。
- `line`: エラーが発生した行番号。
- `original_error`: 元となった例外オブジェクト（存在する場合）。
- `attempt`: 修復の試行回数。
- `details`: その他の詳細情報（辞書形式など）。

## 例外の捕捉と処理

例外の捕捉とログ記録は、自己修復ループの Orchestrator または専用のログ記録モジュールで一元的に管理します。各モジュールで例外を捕捉する際は、以下の点を遵守します。

- 捕捉した例外は、適切なカスタム例外クラスにラップし、必要なコンテキスト情報を付与して再raiseすることを推奨します。
- 例外情報は、指定されたログファイル（例: `FixLogs/repair_log.txt`）に詳細に記録します。
- エラーの種類や含まれる情報に基づいて、再試行、Codeモードへの委譲、Orchestratorへの報告などの次のアクションを決定します。

## ログ記録

例外発生時および修復プロセスの重要なステップでは、ログを記録します。ログにはタイムスタンプ、エラーレベル、エラーメッセージ、および例外オブジェクトに含まれる詳細情報を含めます。

- エラー修復ログ保存先: `/Logs/ErrorFix/`
- 実行ログと修正差分ログ保存先: `/Logs/History/`

## テスト戦略

自己修復ループの例外処理に関するテストでは、以下の点をカバーします。

- 各カスタム例外クラスが正しく定義され、必要な情報を含めることができること。
- 意図的にエラーを発生させ、例外が正しく捕捉され、必要な情報がログに記録されること。
- 例外の種類や情報に基づいて、自己修復ループが期待される動作（再試行、処理中断など）を行うこと。