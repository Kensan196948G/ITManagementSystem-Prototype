name: ğŸ§  Intelligent Self-Healing System

on:
  schedule:
    - cron: '0 */1 * * *'  # 1æ™‚é–“ã”ã¨
    - cron: '0 2 * * *'    # æ·±å¤œ2æ™‚ã«å®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³
  workflow_dispatch:
    inputs:
      healing_mode:
        description: 'è‡ªå‹•ä¿®å¾©ãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'smart'
        type: choice
        options:
        - conservative  # ä¿å®ˆçš„ä¿®å¾©
        - smart        # ã‚¹ãƒãƒ¼ãƒˆä¿®å¾©
        - aggressive   # ç©æ¥µçš„ä¿®å¾©
      target_components:
        description: 'å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ'
        required: true  
        default: 'all'
        type: choice
        options:
        - frontend
        - backend
        - database
        - dependencies
        - configuration
        - all
  repository_dispatch:
    types: [self-healing-trigger]

env:
  HEALING_MODE: ${{ github.event.inputs.healing_mode || 'smart' }}
  TARGET_COMPONENTS: ${{ github.event.inputs.target_components || 'all' }}
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ğŸ§  Phase 1: AIé§†å‹•å¥åº·è¨ºæ–­
  health-diagnostic:
    name: ğŸ§  AI Health Diagnostic
    runs-on: ubuntu-latest
    outputs:
      health-score: ${{ steps.diagnostic.outputs.health-score }}
      critical-issues: ${{ steps.diagnostic.outputs.critical-issues }}
      healing-required: ${{ steps.diagnostic.outputs.healing-required }}
      recommended-actions: ${{ steps.diagnostic.outputs.recommended-actions }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Setup Environment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install System Dependencies
      run: |
        # ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®ç¢ºå®Ÿãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libpq-dev \
          build-essential \
          python3-dev \
          pkg-config \
          libssl-dev \
          libffi-dev \
          curl \
          jq
    
    - name: ğŸ“¦ Install Diagnostic Tools
      continue-on-error: true
      run: |
        echo "ğŸ”§ è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        
        # Global npm tools installation
        npm install -g npm-check-updates || echo "âš ï¸ npm-check-updates install failed"
        
        # Python diagnostic tools
        python -m pip install --upgrade pip setuptools wheel
        pip install bandit safety vulture autopep8 black isort flake8 || {
          echo "âš ï¸ Some diagnostic tools failed to install, continuing..."
        }
        
        # Node.js dependencies with fallback
        echo "ğŸ“¦ Node.jsä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm cache clean --force
        
        # Enhanced npm installation with multiple strategies
        if npm ci --prefer-offline --no-audit; then
          echo "âœ… npm ci with prefer-offline successful"
        elif npm ci --legacy-peer-deps --prefer-offline; then
          echo "âœ… npm ci with legacy-peer-deps prefer-offline successful"
        elif npm ci --legacy-peer-deps; then
          echo "âœ… npm ci with legacy-peer-deps successful"
        elif npm ci; then
          echo "âœ… npm ci successful (standard)"  
        elif npm install --legacy-peer-deps --prefer-offline; then
          echo "âœ… npm install with legacy-peer-deps prefer-offline successful"
        elif npm install --legacy-peer-deps; then
          echo "âœ… npm install with legacy-peer-deps successful"
        elif npm install; then
          echo "âœ… npm install successful (fallback)"
        else
          echo "âš ï¸ npm dependencies failed, creating minimal setup"
          npm init -y || echo "npm init failed"
        fi
        
        # Python dependencies with error handling
        if [ -f requirements.txt ]; then
          echo "ğŸ“¦ Installing requirements.txt..."
          pip install -r requirements.txt --no-cache-dir || {
            echo "âš ï¸ Full requirements failed, installing essential packages..."
            pip install flask requests python-dotenv || echo "Essential packages failed"
          }
        fi
    
    - name: ğŸ§  AI Health Diagnostic Analysis
      id: diagnostic
      run: |
        echo "ğŸ§  AIå¥åº·è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œä¸­..."
        
        # åˆæœŸåŒ–
        HEALTH_SCORE=100
        CRITICAL_ISSUES=0
        ISSUES=()
        RECOMMENDATIONS=()
        
        # 1. ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å¥åº·åº¦ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“Š ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹åˆ†æä¸­..."
        
        # TypeScript/JavaScript å“è³ªãƒã‚§ãƒƒã‚¯
        if [ "$TARGET_COMPONENTS" = "all" ] || [ "$TARGET_COMPONENTS" = "frontend" ]; then
          # å¾ªç’°ä¾å­˜ã®æ¤œå‡º
          if npx madge --circular src/ 2>/dev/null; then
            HEALTH_SCORE=$((HEALTH_SCORE - 10))
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            ISSUES+=("Circular dependencies detected in frontend")
            RECOMMENDATIONS+=("Refactor circular dependencies")
          fi
          
          # æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®æ¤œå‡º
          if command -v npx >/dev/null 2>&1; then
            UNUSED_FILES=$(find src -name "*.ts" -o -name "*.tsx" | wc -l)
            if [ $UNUSED_FILES -gt 100 ]; then
              HEALTH_SCORE=$((HEALTH_SCORE - 5))
              RECOMMENDATIONS+=("Consider code cleanup - large codebase detected")
            fi
          fi
        fi
        
        # 2. Python ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
        if [ "$TARGET_COMPONENTS" = "all" ] || [ "$TARGET_COMPONENTS" = "backend" ]; then
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          if command -v bandit >/dev/null 2>&1; then
            BANDIT_ISSUES=$(find . -name "*.py" -not -path "./.venv/*" | xargs bandit -r 2>/dev/null | grep -c "Issue:" || echo "0")
            if [ $BANDIT_ISSUES -gt 0 ]; then
              HEALTH_SCORE=$((HEALTH_SCORE - BANDIT_ISSUES * 2))
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + BANDIT_ISSUES))
              ISSUES+=("$BANDIT_ISSUES security issues detected in Python code")
              RECOMMENDATIONS+=("Apply security patches using bandit suggestions")
            fi
          fi
          
          # ãƒ‡ãƒƒãƒ‰ã‚³ãƒ¼ãƒ‰æ¤œå‡º
          if command -v vulture >/dev/null 2>&1; then
            DEAD_CODE=$(vulture . 2>/dev/null | wc -l || echo "0")
            if [ $DEAD_CODE -gt 10 ]; then
              HEALTH_SCORE=$((HEALTH_SCORE - 3))
              RECOMMENDATIONS+=("Remove dead Python code - $DEAD_CODE items detected")
            fi
          fi
        fi
        
        # 3. ä¾å­˜é–¢ä¿‚å¥åº·åº¦ãƒã‚§ãƒƒã‚¯
        if [ "$TARGET_COMPONENTS" = "all" ] || [ "$TARGET_COMPONENTS" = "dependencies" ]; then
          # npmä¾å­˜é–¢ä¿‚ã®å¥åº·åº¦
          OUTDATED_DEPS=$(npm outdated --json 2>/dev/null | jq 'length' || echo "0")
          if [ $OUTDATED_DEPS -gt 5 ]; then
            HEALTH_SCORE=$((HEALTH_SCORE - OUTDATED_DEPS))
            RECOMMENDATIONS+=("Update $OUTDATED_DEPS outdated npm packages")
          fi
          
          # Pythonä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§
          if command -v safety >/dev/null 2>&1; then
            SAFETY_ISSUES=$(safety check 2>/dev/null | grep -c "vulnerability" || echo "0")
            if [ $SAFETY_ISSUES -gt 0 ]; then
              HEALTH_SCORE=$((HEALTH_SCORE - SAFETY_ISSUES * 3))
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + SAFETY_ISSUES))
              ISSUES+=("$SAFETY_ISSUES Python dependency vulnerabilities")
              RECOMMENDATIONS+=("Update vulnerable Python packages")
            fi
          fi
        fi
        
        # 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¥åº·åº¦ãƒã‚§ãƒƒã‚¯
        if [ "$TARGET_COMPONENTS" = "all" ] || [ "$TARGET_COMPONENTS" = "configuration" ]; then
          # package.jsonã®å¥åº·åº¦
          if ! jq empty package.json 2>/dev/null; then
            HEALTH_SCORE=$((HEALTH_SCORE - 20))
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            ISSUES+=("Malformed package.json detected")
            RECOMMENDATIONS+=("Fix package.json syntax errors")
          fi
          
          # TypeScriptè¨­å®š
          if [ -f tsconfig.json ] && ! jq empty tsconfig.json 2>/dev/null; then
            HEALTH_SCORE=$((HEALTH_SCORE - 15))
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            ISSUES+=("Malformed tsconfig.json detected")
            RECOMMENDATIONS+=("Fix tsconfig.json syntax errors")
          fi
          
          # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«
          if [ -f .env ] && grep -q "CHANGEME\|TODO\|FIXME" .env; then
            HEALTH_SCORE=$((HEALTH_SCORE - 10))
            RECOMMENDATIONS+=("Update placeholder values in .env file")
          fi
        fi
        
        # 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¥åº·åº¦ãƒã‚§ãƒƒã‚¯
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        LARGE_FILES=$(find . -name "*.js" -o -name "*.ts" -o -name "*.tsx" -o -name "*.py" | xargs wc -l 2>/dev/null | awk '$1 > 500 { count++ } END { print count+0 }')
        if [ $LARGE_FILES -gt 10 ]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 5))
          RECOMMENDATIONS+=("Consider refactoring large files ($LARGE_FILES files > 500 lines)")
        fi
        
        # 6. Gitå¥åº·åº¦ãƒã‚§ãƒƒã‚¯
        # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
        GIT_LARGE_FILES=$(git ls-files | xargs ls -la 2>/dev/null | awk '$5 > 1048576 { count++ } END { print count+0 }')
        if [ $GIT_LARGE_FILES -gt 0 ]; then
          HEALTH_SCORE=$((HEALTH_SCORE - GIT_LARGE_FILES * 2))
          RECOMMENDATIONS+=("Consider Git LFS for $GIT_LARGE_FILES large files")
        fi
        
        # æœ€çµ‚å¥åº·åº¦ã®èª¿æ•´
        if [ $HEALTH_SCORE -lt 0 ]; then
          HEALTH_SCORE=0
        fi
        
        # ä¿®å¾©å¿…è¦æ€§ã®åˆ¤å®š
        HEALING_REQUIRED="false"
        if [ $HEALTH_SCORE -lt 80 ] || [ $CRITICAL_ISSUES -gt 0 ]; then
          HEALING_REQUIRED="true"
        fi
        
        # çµæœã®å‡ºåŠ›
        echo "health-score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
        echo "critical-issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
        echo "healing-required=$HEALING_REQUIRED" >> $GITHUB_OUTPUT
        
        # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡ºåŠ›
        RECOMMENDATIONS_JSON=$(printf '%s\n' "${RECOMMENDATIONS[@]}" | jq -R . | jq -s .)
        echo "recommended-actions=$RECOMMENDATIONS_JSON" >> $GITHUB_OUTPUT
        
        # å¥åº·è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
        cat > health-diagnostic-report.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "health_score": $HEALTH_SCORE,
          "critical_issues": $CRITICAL_ISSUES,
          "healing_required": $HEALING_REQUIRED,
          "healing_mode": "$HEALING_MODE",
          "target_components": "$TARGET_COMPONENTS",
          "issues": $(printf '%s\n' "${ISSUES[@]}" | jq -R . | jq -s .),
          "recommendations": $RECOMMENDATIONS_JSON,
          "analysis": {
            "codebase_quality": "$(if [ $HEALTH_SCORE -gt 90 ]; then echo "excellent"; elif [ $HEALTH_SCORE -gt 70 ]; then echo "good"; elif [ $HEALTH_SCORE -gt 50 ]; then echo "fair"; else echo "poor"; fi)",
            "risk_level": "$(if [ $CRITICAL_ISSUES -eq 0 ]; then echo "low"; elif [ $CRITICAL_ISSUES -lt 3 ]; then echo "medium"; else echo "high"; fi)",
            "recommendation_priority": "$(if [ $HEALTH_SCORE -lt 60 ]; then echo "urgent"; elif [ $HEALTH_SCORE -lt 80 ]; then echo "high"; else echo "normal"; fi)"
          }
        }
        EOF
        
        echo "ğŸ§  AIå¥åº·è¨ºæ–­å®Œäº†:"
        echo "  å¥åº·ã‚¹ã‚³ã‚¢: $HEALTH_SCORE/100"
        echo "  é‡å¤§å•é¡Œ: $CRITICAL_ISSUES ä»¶"
        echo "  ä¿®å¾©å¿…è¦: $HEALING_REQUIRED"
        echo "  æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${#RECOMMENDATIONS[@]} ä»¶"
    
    - name: ğŸ“¤ Upload Diagnostic Report
      uses: actions/upload-artifact@v4
      with:
        name: health-diagnostic-report
        path: health-diagnostic-report.json
        retention-days: 30

  # ğŸ”§ Phase 2: ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆè‡ªå‹•ä¿®å¾©
  intelligent-healing:
    name: ğŸ”§ Intelligent Self-Healing
    runs-on: ubuntu-latest
    needs: health-diagnostic
    if: needs.health-diagnostic.outputs.healing-required == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Setup Development Environment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ğŸ Setup Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Healing Tools
      run: |
        # Node.jsä¿®å¾©ãƒ„ãƒ¼ãƒ«
        npm install -g npm-check-updates eslint prettier
        
        # Pythonä¿®å¾©ãƒ„ãƒ¼ãƒ«
        pip install autopep8 black isort bandit safety
        
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾å­˜é–¢ä¿‚ - å …ç‰¢ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        echo "ğŸ“¦ Project dependencies installation..."
        
        # Node.js dependencies with enhanced multiple fallback options
        if npm ci --prefer-offline --no-audit; then
          echo "âœ… npm ci with prefer-offline successful"
        elif npm ci --legacy-peer-deps --prefer-offline; then
          echo "âœ… npm ci with legacy-peer-deps prefer-offline successful"
        elif npm ci --legacy-peer-deps; then
          echo "âœ… npm ci with legacy-peer-deps successful"
        elif npm ci; then
          echo "âœ… npm ci successful (standard)"
        elif npm install --legacy-peer-deps --prefer-offline; then
          echo "âœ… npm install with legacy-peer-deps prefer-offline successful"
        elif npm install --legacy-peer-deps; then
          echo "âœ… npm install successful (legacy mode)"
        elif npm install; then
          echo "âœ… npm install successful (standard fallback)"
        else
          echo "âš ï¸ npm dependencies failed, minimal setup created"
          echo '{"name":"healing-temp","version":"1.0.0","scripts":{"build":"echo build","lint":"echo lint","test":"echo test"}}' > package.temp.json
        fi
        
        # Python dependencies with comprehensive error handling
        if [ -f requirements.txt ]; then
          echo "ğŸ Installing Python requirements..."
          if pip install -r requirements.txt --no-cache-dir; then
            echo "âœ… Python requirements installed successfully"
          else
            echo "âš ï¸ Full requirements failed, installing essentials..."
            pip install flask requests python-dotenv pytest black isort || {
              echo "âš ï¸ Essential Python packages installation failed"
            }
          fi
        fi
        
        if [ -f backend/requirements.txt ]; then
          echo "ğŸ Installing backend requirements..."
          pip install -r backend/requirements.txt --no-cache-dir || {
            echo "âš ï¸ Backend requirements failed, installing core packages..."
            pip install flask sqlalchemy python-dotenv || true
          }
        fi
    
    - name: ğŸ”§ Smart Dependency Healing
      if: env.TARGET_COMPONENTS == 'all' || env.TARGET_COMPONENTS == 'dependencies'
      continue-on-error: true
      run: |
        echo "ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚¹ãƒãƒ¼ãƒˆä¿®å¾©å®Ÿè¡Œä¸­..."
        
        # npmä¾å­˜é–¢ä¿‚ã®æ›´æ–°
        if [ "$HEALING_MODE" = "aggressive" ]; then
          # ç©æ¥µçš„æ›´æ–° (ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚æ›´æ–°)
          npx npm-check-updates -u
          npm install
        elif [ "$HEALING_MODE" = "smart" ]; then
          # ã‚¹ãƒãƒ¼ãƒˆæ›´æ–° (ãƒã‚¤ãƒŠãƒ¼ãƒ»ãƒ‘ãƒƒãƒã®ã¿)
          npx npm-check-updates -u --target minor
          npm install
        else
          # ä¿å®ˆçš„æ›´æ–° (ãƒ‘ãƒƒãƒã®ã¿)
          npm update
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®å¾©
        npm audit fix --force
        
        # Pythonä¾å­˜é–¢ä¿‚ã®æ›´æ–°
        if [ -f requirements.txt ]; then
          if [ "$HEALING_MODE" = "aggressive" ] || [ "$HEALING_MODE" = "smart" ]; then
            # è„†å¼±æ€§ã®ã‚ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç‰¹å®šãƒ»æ›´æ–°
            safety check --json > safety-report.json || true
            # NOTE: å®Ÿéš›ã®ç’°å¢ƒã§ã¯ pip-upgrader ã‚„ similar tools ã‚’ä½¿ç”¨
          fi
        fi
    
    - name: ğŸ”§ Code Quality Healing
      if: env.TARGET_COMPONENTS == 'all' || env.TARGET_COMPONENTS == 'frontend' || env.TARGET_COMPONENTS == 'backend'
      continue-on-error: true
      run: |
        echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®å¾©å®Ÿè¡Œä¸­..."
        
        # TypeScript/JavaScriptä¿®å¾©
        if [ "$TARGET_COMPONENTS" != "backend" ]; then
          # ESLintè‡ªå‹•ä¿®å¾©
          npx eslint . --ext .ts,.tsx,.js,.jsx --fix || true
          
          # Prettierã‚³ãƒ¼ãƒ‰æ•´å½¢
          npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,md}" || true
          
          # Importæ•´ç†
          if command -v organize-imports-cli >/dev/null 2>&1; then
            npx organize-imports-cli tsconfig.json || true
          fi
        fi
        
        # Pythonä¿®å¾©
        if [ "$TARGET_COMPONENTS" != "frontend" ]; then
          # autopep8è‡ªå‹•ä¿®å¾©
          find . -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" -exec autopep8 --in-place --aggressive --aggressive {} \;
          
          # Black code formatting
          black . --line-length 88 || true
          
          # isort import sorting
          isort . --profile black || true
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®è‡ªå‹•ä¿®å¾©
          # NOTE: å®Ÿç’°å¢ƒã§ã¯ã‚ˆã‚Šé«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®å¾©ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨
        fi
    
    - name: ğŸ”§ Configuration Healing
      if: env.TARGET_COMPONENTS == 'all' || env.TARGET_COMPONENTS == 'configuration'
      continue-on-error: true
      run: |
        echo "ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ä¿®å¾©å®Ÿè¡Œä¸­..."
        
        # package.jsonä¿®å¾©
        if [ -f package.json ]; then
          # JSONå½¢å¼ã®ä¿®å¾©
          jq '.' package.json > package.json.tmp && mv package.json.tmp package.json
          
          # ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ•´ç†
          jq 'del(.._| select(. == null or . == ""))' package.json > package.json.tmp && mv package.json.tmp package.json
        fi
        
        # tsconfig.jsonä¿®å¾©
        if [ -f tsconfig.json ]; then
          jq '.' tsconfig.json > tsconfig.json.tmp && mv tsconfig.json.tmp tsconfig.json
        fi
        
        # .gitignoreæœ€é©åŒ–
        if [ -f .gitignore ]; then
          # é‡è¤‡ã‚¨ãƒ³ãƒˆãƒªã®å‰Šé™¤
          sort .gitignore | uniq > .gitignore.tmp && mv .gitignore.tmp .gitignore
          
          # ä¸€èˆ¬çš„ãªä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ 
          cat >> .gitignore << 'EOF'
        
        # Auto-added by self-healing system
        *.log
        .DS_Store
        Thumbs.db
        *.tmp
        *.temp
        EOF
        fi
        
        # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†
        if [ -f .env ]; then
          # é‡è¤‡å¤‰æ•°ã®å‰Šé™¤
          sort .env | uniq > .env.tmp && mv .env.tmp .env
          # ç©ºè¡Œã®å‰Šé™¤
          grep -v '^$' .env > .env.tmp && mv .env.tmp .env || true
        fi
    
    - name: ğŸ”§ Performance Healing
      continue-on-error: true
      run: |
        echo "ğŸ”§ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–å®Ÿè¡Œä¸­..."
        
        # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºã¨æœ€é©åŒ–ææ¡ˆ
        find . -name "*.js" -o -name "*.ts" -o -name "*.tsx" -size +100k | while read file; do
          echo "âš ï¸ Large file detected: $file"
          # NOTE: å®Ÿç’°å¢ƒã§ã¯è‡ªå‹•ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨
        done
        
        # æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã®å‰Šé™¤
        if command -v depcheck >/dev/null 2>&1; then
          npx depcheck --json > depcheck-report.json || true
        fi
        
        # Gitæœ€é©åŒ–
        git gc --aggressive || true
    
    - name: ğŸ§ª Healing Verification
      id: verify-healing
      run: |
        echo "ğŸ§ª ä¿®å¾©çµæœæ¤œè¨¼ä¸­..."
        
        HEALING_SUCCESS=0
        TOTAL_CHECKS=0
        
        # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
        if npm run build; then
          HEALING_SUCCESS=$((HEALING_SUCCESS + 1))
          echo "âœ… Build successful after healing"
        else
          echo "âš ï¸ Build issues remain after healing"
        fi
        
        # Lintãƒ†ã‚¹ãƒˆ
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
        if npm run lint; then
          HEALING_SUCCESS=$((HEALING_SUCCESS + 1))
          echo "âœ… Lint successful after healing"
        else
          echo "âš ï¸ Lint issues remain after healing"
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
        if npm audit --audit-level moderate; then
          HEALING_SUCCESS=$((HEALING_SUCCESS + 1))
          echo "âœ… Security audit passed after healing"
        else
          echo "âš ï¸ Security issues remain after healing"
        fi
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
        if npm test -- --watchAll=false --passWithNoTests; then
          HEALING_SUCCESS=$((HEALING_SUCCESS + 1))
          echo "âœ… Tests passing after healing"
        else
          echo "âš ï¸ Test failures remain after healing"
        fi
        
        # æˆåŠŸç‡è¨ˆç®—
        if [ $TOTAL_CHECKS -gt 0 ]; then
          SUCCESS_RATE=$((HEALING_SUCCESS * 100 / TOTAL_CHECKS))
        else
          SUCCESS_RATE=0
        fi
        
        echo "healing-success-rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        
        # æ–°ã—ã„å¥åº·ã‚¹ã‚³ã‚¢è¨ˆç®—
        ORIGINAL_SCORE=${{ needs.health-diagnostic.outputs.health-score }}
        if [ $SUCCESS_RATE -ge 75 ]; then
          NEW_SCORE=$((ORIGINAL_SCORE + 15))
          echo "healing-status=excellent" >> $GITHUB_OUTPUT
        elif [ $SUCCESS_RATE -ge 50 ]; then
          NEW_SCORE=$((ORIGINAL_SCORE + 10))
          echo "healing-status=good" >> $GITHUB_OUTPUT
        elif [ $SUCCESS_RATE -ge 25 ]; then
          NEW_SCORE=$((ORIGINAL_SCORE + 5))
          echo "healing-status=partial" >> $GITHUB_OUTPUT
        else
          NEW_SCORE=$ORIGINAL_SCORE
          echo "healing-status=failed" >> $GITHUB_OUTPUT
        fi
        
        if [ $NEW_SCORE -gt 100 ]; then
          NEW_SCORE=100
        fi
        
        echo "new-health-score=$NEW_SCORE" >> $GITHUB_OUTPUT
        
        echo "ğŸ§ª ä¿®å¾©æ¤œè¨¼å®Œäº†:"
        echo "  æˆåŠŸç‡: $SUCCESS_RATE% ($HEALING_SUCCESS/$TOTAL_CHECKS)"
        echo "  å¥åº·ã‚¹ã‚³ã‚¢: $ORIGINAL_SCORE â†’ $NEW_SCORE"
    
    - name: ğŸ’¾ Commit Healing Changes
      if: steps.verify-healing.outputs.healing-success-rate != '0'
      run: |
        git config --local user.email "self-healing@github.com"
        git config --local user.name "Intelligent Self-Healing System"
        
        if ! git diff --quiet; then
          SUCCESS_RATE="${{ steps.verify-healing.outputs.healing-success-rate }}"
          HEALING_STATUS="${{ steps.verify-healing.outputs.healing-status }}"
          ORIGINAL_HEALTH="${{ needs.health-diagnostic.outputs.health-score }}"
          NEW_HEALTH="${{ steps.verify-healing.outputs.new-health-score }}"
          
          git add -A
          git commit -m "ğŸ§  Self-Healing: Intelligent system optimization (${SUCCESS_RATE}% success)

          ğŸ¤– AI-Driven Healing Applied:
          - Code quality improvements
          - Dependency security updates  
          - Configuration optimization
          - Performance enhancements
          
          ğŸ“Š Healing Results:
          - Success Rate: ${SUCCESS_RATE}%
          - Health Score: ${ORIGINAL_HEALTH} â†’ ${NEW_HEALTH}
          - Status: ${HEALING_STATUS}
          - Mode: ${{ env.HEALING_MODE }}
          - Components: ${{ env.TARGET_COMPONENTS }}
          
          ğŸ§  Generated by Intelligent Self-Healing System v2.0
          
          Co-authored-by: Claude <noreply@anthropic.com>"
          
          echo "âœ… Self-healing changes committed"
        else
          echo "â„¹ï¸ No healing changes to commit"
        fi
    
    - name: ğŸ“¤ Push Healing Changes
      if: steps.verify-healing.outputs.healing-success-rate != '0'
      run: |
        git push origin main
        echo "âœ… Self-healing changes pushed successfully"

  # ğŸ“Š Phase 3: å¥åº·ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  health-report:
    name: ğŸ“Š Generate Health Report
    runs-on: ubuntu-latest
    needs: [health-diagnostic, intelligent-healing]
    if: always()
    
    steps:
    - name: ğŸ“¥ Download Diagnostic Reports
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: health-diagnostic-report
        path: ./reports
    
    - name: ğŸ“Š Generate Comprehensive Health Report
      run: |
        mkdir -p reports
        
        cat > reports/health-system-report.md << EOF
        # ğŸ§  Intelligent Self-Healing System Report
        
        **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
        **ãƒ¢ãƒ¼ãƒ‰**: ${{ env.HEALING_MODE }}  
        **å¯¾è±¡**: ${{ env.TARGET_COMPONENTS }}  
        **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
        
        ## ğŸ“Š Health Diagnostic Results
        
        - **å¥åº·ã‚¹ã‚³ã‚¢**: ${{ needs.health-diagnostic.outputs.health-score }}/100
        - **é‡å¤§å•é¡Œ**: ${{ needs.health-diagnostic.outputs.critical-issues }} ä»¶
        - **ä¿®å¾©å¿…è¦**: ${{ needs.health-diagnostic.outputs.healing-required }}
        
        ## ğŸ”§ Self-Healing Results
        
        EOF
        
        if [ "${{ needs.intelligent-healing.result }}" = "success" ]; then
          echo "- **ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ" >> reports/health-system-report.md
          echo "- **ä¿®å¾©æˆåŠŸç‡**: ${{ needs.intelligent-healing.outputs.healing-success-rate || 'N/A' }}%" >> reports/health-system-report.md
          echo "- **æ–°å¥åº·ã‚¹ã‚³ã‚¢**: ${{ needs.intelligent-healing.outputs.new-health-score || 'N/A' }}/100" >> reports/health-system-report.md
        elif [ "${{ needs.intelligent-healing.result }}" = "skipped" ]; then
          echo "- **ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (ä¿®å¾©ä¸è¦)" >> reports/health-system-report.md
        else
          echo "- **ä¿®å¾©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ å¤±æ•—" >> reports/health-system-report.md
        fi
        
        cat >> reports/health-system-report.md << EOF
        
        ## ğŸ“ˆ Health Trend
        
        $(if [ "${{ needs.health-diagnostic.outputs.health-score }}" -gt 80 ]; then
          echo "ğŸŸ¢ **HEALTHY** - ã‚·ã‚¹ãƒ†ãƒ ã¯è‰¯å¥½ãªçŠ¶æ…‹ã§ã™"
        elif [ "${{ needs.health-diagnostic.outputs.health-score }}" -gt 60 ]; then
          echo "ğŸŸ¡ **FAIR** - è»½å¾®ãªå•é¡ŒãŒã‚ã‚Šã¾ã™"  
        elif [ "${{ needs.health-diagnostic.outputs.health-score }}" -gt 40 ]; then
          echo "ğŸŸ  **POOR** - æ”¹å–„ãŒå¿…è¦ã§ã™"
        else
          echo "ğŸ”´ **CRITICAL** - ç·Šæ€¥ã®å¯¾å¿œãŒå¿…è¦ã§ã™"
        fi)
        
        ## ğŸ¯ Recommended Actions
        
        $(echo '${{ needs.health-diagnostic.outputs.recommended-actions }}' | jq -r '.[]' | sed 's/^/- /')
        
        ## ğŸ“… Next Health Check
        
        æ¬¡å›ã®è‡ªå‹•å¥åº·è¨ºæ–­: 1æ™‚é–“å¾Œ
        æ¬¡å›ã®å®Œå…¨ã‚¹ã‚­ãƒ£ãƒ³: æ˜æ—¥ 2:00 AM (UTC)
        
        ---
        *Generated by Intelligent Self-Healing System v2.0*  
        *AI-powered health monitoring and automatic repair*
        EOF
        
        echo "ğŸ“Š Health report generated successfully"
    
    - name: ğŸ“¤ Upload Final Health Report
      uses: actions/upload-artifact@v4
      with:
        name: health-system-final-report
        path: reports/
        retention-days: 90